<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= pageTitle %></title>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <div class="header-content">
        <h1>
          <%= headerTitle %><img
            style="width: 80px; vertical-align: middle"
            src="<%= headerLogo %>"
            alt="Logo"
          />
        </h1>
        <nav class="nav-menu">
          <a href="/" class="nav-link <%= active === 'list' ? 'active' : '' %>"
            >Listar</a
          >
          <a
            href="/create"
            class="nav-link <%= active === 'create' ? 'active' : '' %>"
            >Criar</a
          >
        </nav>
      </div>
    </header>

    <div class="container">
      <div id="alertContainer"></div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Lista de Produtos</h2>
          <button type="button" class="btn btn-success" id="refreshBtn">
            Atualizar
          </button>
        </div>

        <div id="loadingContainer" class="loading" style="display: none">
          <div class="spinner"></div>
          <span>Carregando produtos...</span>
        </div>

        <div class="table-container" id="tableContainer">
          <table id="productsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Descri√ß√£o</th>
                <th>Pre√ßo</th>
                <th>Estoque</th>
                <th style="width: 120px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="productsBody"></tbody>
          </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
          </svg>
          <h3>Nenhum produto cadastrado</h3>
          <p>Adicione seu primeiro produto clicando em "Criar" no menu.</p>
        </div>
      </div>
    </div>

    <!-- Client-side config + utils -->
    <script src="/config.js"></script>
    <script src="/utils.js"></script>

    <script>
      const productsBody = document.getElementById("productsBody");
      const loadingContainer = document.getElementById("loadingContainer");
      const tableContainer = document.getElementById("tableContainer");
      const emptyState = document.getElementById("emptyState");
      const refreshBtn = document.getElementById("refreshBtn");

      document.addEventListener("DOMContentLoaded", () => {
        loadProducts();
        refreshBtn.addEventListener("click", loadProducts);
      });

      async function loadProducts() {
        showLoading(true);

        try {
          const response = await fetch(API_BASE_URL);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const products = await response.json();
          renderProducts(products);
        } catch (error) {
          console.error("Erro ao carregar produtos:", error);
          showAlert(`Erro ao carregar produtos: ${error.message}`, "error");
          productsBody.innerHTML = "";
          emptyState.style.display = "block";
        } finally {
          showLoading(false);
        }
      }

      function renderProducts(products) {
        productsBody.innerHTML = "";

        if (!products || products.length === 0) {
          tableContainer.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        tableContainer.style.display = "block";
        emptyState.style.display = "none";

        products.forEach((product) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${product.id}</td>
                    <td><strong>${escapeHtml(product.name)}</strong></td>
                    <td>${escapeHtml(product.description || "-")}</td>
                    <td>R$ ${formatPrice(product.price)}</td>
                    <td>${product.stock}</td>
                    <td>
                        <div class="actions">
                            <a href="/view?id=${
                              product.id
                            }" class="btn-icon view" title="Visualizar">
                                üîç
                            </a>
                            <a href="/edit?id=${
                              product.id
                            }" class="btn-icon edit" title="Editar">
                                ‚úèÔ∏è
                            </a>
                            <button class="btn-icon delete" onclick="deleteProduct(${
                              product.id
                            })" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
          productsBody.appendChild(row);
        });
      }

      async function deleteProduct(id) {
        if (!confirm("Tem certeza que deseja excluir este produto?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            if (response.status === 404) {
              throw new Error("Produto n√£o encontrado");
            }
            throw new Error("Erro ao excluir produto");
          }

          showAlert("Produto exclu√≠do com sucesso!", "success");
          loadProducts();
        } catch (error) {
          console.error("Erro ao excluir produto:", error);
          showAlert(`Erro ao excluir produto: ${error.message}`, "error");
        }
      }

      function showLoading(show) {
        loadingContainer.style.display = show ? "flex" : "none";
        tableContainer.style.display = show ? "none" : "block";
      }
    </script>
  </body>
</html>
